<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>易經卦象輸入與支卦顯示</title>
  <!-- 響應式設定 -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- 引入 Vue.js -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    h1, h2, h3 {
      text-align: center;
    }
    /* 提示訊息 */
    .hint {
      text-align: center;
      font-size: 0.95em;
      color: #555;
      margin-bottom: 10px;
    }
    /* 今天時刻輸入區 */
    .time-input {
      margin: 20px auto;
      text-align: center;
    }
    .time-input select {
      width: 50px;
      text-align: center;
      margin: 0 5px;
    }
    .time-input span {
      margin: 0 5px;
      font-weight: bold;
    }
    .day-element, .kongwang {
      margin-top: 5px;
      font-size: 0.9em;
      color: #555;
    }
    .kongwang {
      color: #007;
    }
    /* 外層容器 */
    .hexagrams-wrapper {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      align-items: flex-start;
      margin-top: 20px;
    }
    .hexagram {
      padding: 10px;
      border: 1px solid #ccc;
      min-width: 320px;
      flex: 1 1 320px;
      margin: 10px;
    }
    /* 共同爻容器 */
    .lines-container {
      display: flex;
      flex-direction: column-reverse;
    }
    .line, .support-line {
      display: flex;
      align-items: center;
      margin: 5px 0;
      height: 50px;
    }
    /* 六獸標籤 */
    .beast-label {
      width: 60px;
      text-align: left;
      margin-right: 10px;
      font-weight: bold;
      color: #008;
    }
    .line-label {
      width: 60px;
      text-align: right;
      margin-right: 10px;
      font-weight: bold;
    }
    /* 小圓圈 */
    .circle {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: grey;
      cursor: pointer;
      border: 1px solid #ccc;
      margin-right: 10px;
    }
    .circle.active {
      background-color: red;
    }
    /* 爻形狀 */
    .line-shape {
      cursor: pointer;
      position: relative;
    }
    .yang-line {
      width: 60px;
      height: 10px;
      background-color: currentColor;
      margin-bottom: 2px;
    }
    .yin-line-container {
      width: 60px;
      height: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2px;
    }
    .yin-line-rect {
      width: 20px;
      height: 10px;
      background-color: currentColor;
    }
    /* 判定描述（沖／建及五行判定）顯示於六親右側 */
    .chongjian-label {
      margin-left: 10px;
      font-size: 0.85em;
      color: #990;
    }
    .liuQin-container {
      margin-left: 10px;
      font-size: 0.85em;
      color: #333;
      white-space: nowrap;
    }
    .shiYing {
      font-size: 0.8em;
      color: #a00;
    }
    .fuShen {
      font-size: 0.75em;
      color: #00a;
    }
    @media screen and (max-width: 480px) {
      body { margin: 10px; }
      .hexagram { min-width: 280px; }
      .line-label, .beast-label, .chongjian-label { width: 50px; font-size: 0.9em; }
      .liuQin-container, .shiYing, .fuShen { font-size: 0.75em; }
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>易經卦象輸入</h1>
    <!-- 提示訊息 -->
    <div class="hint">
      提示：點選小圓圈可切換動爻狀態，點選爻線可切換陰陽狀態。
    </div>
    
    <!-- 今天時刻輸入區 -->
    <div class="time-input">
      <h3>今天的時刻（自動計算）</h3>
      <!-- 年 -->
      <select v-model="today.yearTian">
        <option v-for="stem in heavenlyStems" :value="stem">{{ stem }}</option>
      </select>
      <select v-model="today.yearDi">
        <option v-for="branch in earthlyBranches" :value="branch">{{ branch }}</option>
      </select>
      <span>年</span>
      <!-- 月 -->
      <select v-model="today.monthTian">
        <option v-for="stem in heavenlyStems" :value="stem">{{ stem }}</option>
      </select>
      <select v-model="today.monthDi">
        <option v-for="branch in earthlyBranches" :value="branch">{{ branch }}</option>
      </select>
      <span>月</span>
      <!-- 日 -->
      <select v-model="today.dayTian">
        <option v-for="stem in heavenlyStems" :value="stem">{{ stem }}</option>
      </select>
      <select v-model="today.dayDi">
        <option v-for="branch in earthlyBranches" :value="branch">{{ branch }}</option>
      </select>
      <span>日</span>
      <div class="day-element" v-if="today.dayDi">
        五行：{{ dayElement }}
      </div>
      <div class="kongwang" v-if="today.dayDi">
        日空亡：{{ dayKongWang }}
      </div>
    </div>
    
    <div class="hexagrams-wrapper">
      <!-- 本卦區塊 -->
      <div class="hexagram">
        <h2>本卦：{{ currentHexagram.name }}</h2>
        <p>本宮：{{ currentHexagram.benGong }}</p>
        <div class="lines-container">
          <div v-for="(line, index) in lines" :key="index" class="line">
            <!-- 六獸標籤 -->
            <span class="beast-label">{{ sixBeasts[index] }}</span>
            <span class="line-label">第{{ index + 1 }}爻</span>
            <div :class="['circle', line.isMoving ? 'active' : '']" @click.stop="toggleMoving(index)"></div>
            <div class="line-shape" @click="toggleLine(index)" :style="{ color: line.isMoving ? 'red' : 'black' }">
              <div v-if="line.isYang" class="yang-line"></div>
              <div v-else class="yin-line-container">
                <div class="yin-line-rect"></div>
                <div class="yin-line-rect"></div>
              </div>
              <div class="shiYing" v-if="currentHexagram.shiYing && currentHexagram.shiYing[index]">
                {{ currentHexagram.shiYing[index] }}
              </div>
            </div>
            <div class="liuQin-container" v-if="currentHexagram.liuQin && currentHexagram.liuQin[index]">
              {{ currentHexagram.liuQin[index] }}
            </div>
            <!-- 判定描述顯示於六親右側 -->
            <span class="chongjian-label" v-if="getChongJian(index)">{{ getChongJian(index) }}</span>
            <div class="fuShen" v-if="currentHexagram.fuShen && currentHexagram.fuShen[index]">
              伏神：{{ currentHexagram.fuShen[index] }}
            </div>
          </div>
        </div>
      </div>
      <!-- 支卦區塊 -->
      <div class="hexagram">
        <h2>支卦：{{ supportHexagram.name }}</h2>
        <p>本宮：{{ supportHexagram.benGong }}</p>
        <div class="lines-container">
          <div v-for="(line, index) in supportLines" :key="index" class="support-line">
            <div class="line-shape" :style="{ color: line.isMoving ? 'red' : 'black' }">
              <div v-if="line.isYang" class="yang-line"></div>
              <div v-else class="yin-line-container">
                <div class="yin-line-rect"></div>
                <div class="yin-line-rect"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <p>
      ※ 本卦：依據用戶設定的六爻狀態，由下往上排列。<br>
      ※ 支卦：對每一爻，若為動則反轉其狀態（顯示紅色），否則保持原樣。
    </p>
  </div>

  <script>
    new Vue({
      el: '#app',
      data: {
        today: {
          yearTian: "",
          yearDi: "",
          monthTian: "",
          monthDi: "",
          dayTian: "",
          dayDi: ""
        },
        heavenlyStems: ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"],
        earthlyBranches: ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"],
        branchToElement: {
          "子": "水", "丑": "土", "寅": "木", "卯": "木", "辰": "土",
          "巳": "火", "午": "火", "未": "土", "申": "金", "酉": "金",
          "戌": "土", "亥": "水"
        },
        // 日空亡對應表
        dayKongWangMap: {
          "甲子": "戌亥",
          "乙丑": "戌亥",
          "丙寅": "戌亥",
          "丁卯": "戌亥",
          "戊辰": "戌亥",
          "己巳": "戌亥",
          "庚午": "戌亥",
          "辛未": "戌亥",
          "壬申": "戌亥",
          "葵酉": "戌亥",
          "甲戌": "申酉",
          "乙亥": "申酉",
          "丙子": "申酉",
          "丁丑": "申酉",
          "戊寅": "申酉",
          "己卯": "申酉",
          "庚辰": "申酉",
          "辛巳": "申酉",
          "壬午": "申酉",
          "葵未": "申酉",
          "甲申": "午未",
          "乙酉": "午未",
          "丙戌": "午未",
          "丁亥": "午未",
          "戊子": "午未",
          "己丑": "午未",
          "庚寅": "午未",
          "辛卯": "午未",
          "壬辰": "午未",
          "葵巳": "午未",
          "甲午": "辰巳",
          "乙未": "辰巳",
          "丙申": "辰巳",
          "丁酉": "辰巳",
          "戊戌": "辰巳",
          "己亥": "辰巳",
          "庚子": "辰巳",
          "辛丑": "辰巳",
          "壬寅": "辰巳",
          "葵卯": "辰巳",
          "甲辰": "寅卯",
          "乙巳": "寅卯",
          "丙午": "寅卯",
          "丁未": "寅卯",
          "戊申": "寅卯",
          "己酉": "寅卯",
          "庚戌": "寅卯",
          "辛亥": "寅卯",
          "壬子": "寅卯",
          "葵丑": "寅卯",
          "甲寅": "子丑",
          "乙卯": "子丑",
          "丙辰": "子丑",
          "丁巳": "子丑",
          "戊午": "子丑",
          "己未": "子丑",
          "庚申": "子丑",
          "辛酉": "子丑",
          "壬戌": "子丑",
          "葵亥": "子丑"
        },
        lines: [
          { isYang: true, isMoving: false },
          { isYang: true, isMoving: false },
          { isYang: true, isMoving: false },
          { isYang: true, isMoving: false },
          { isYang: true, isMoving: false },
          { isYang: true, isMoving: false }
        ],
        hexagramMap: {
          "111111": { 
            name: "乾為天", 
            benGong: "乾宮(本宮)", 
            liuQin: ["子水子孫", "寅木妻財", "辰土父母", "午火官鬼", "申金兄弟", "戌土父母"],
            shiYing: ["", "", "應", "", "", "世"],
            fuShen: ["", "", "", "", "", ""]
          },
          // …（其他卦資料保持不變，略）
          "000000": { 
            name: "坤為地", 
            benGong: "坤宮(本宮)", 
            liuQin: ["未土兄弟", "巳火父母", "卯木官鬼", "丑土兄弟", "亥水妻財", "酉金子孫"],
            shiYing: ["", "", "應", "", "", "世"],
            fuShen: ["", "", "", "", "", ""]
          }
        }
      },
      computed: {
        currentPattern() {
          return this.lines.map(line => line.isYang ? "1" : "0").join('');
        },
        currentHexagram() {
          return this.hexagramMap[this.currentPattern] || { 
            name: "未知卦象", 
            benGong: "未知", 
            liuQin: ["", "", "", "", "", ""],
            shiYing: ["", "", "", "", "", ""],
            fuShen: ["", "", "", "", "", ""]
          };
        },
        supportLines() {
          return this.lines.map(line => ({
            isYang: line.isMoving ? !line.isYang : line.isYang,
            isMoving: line.isMoving
          }));
        },
        supportPattern() {
          return this.supportLines.map(line => line.isYang ? "1" : "0").join('');
        },
        supportHexagram() {
          return this.hexagramMap[this.supportPattern] || { 
            name: "未知卦象", 
            benGong: "未知" 
          };
        },
        dayElement() {
          return this.branchToElement[this.today.dayDi] || "";
        },
        dayKongWang() {
          const gz = this.today.dayTian + this.today.dayDi;
          return this.dayKongWangMap[gz] || "";
        },
        // 根據 today.dayTian 決定六獸的順序
        sixBeasts() {
          let stem = this.today.dayTian;
          if (!stem) return ["", "", "", "", "", ""];
          if (stem === "甲" || stem === "乙") {
            return ["青龍", "朱雀", "勾陳", "騰蛇", "白虎", "玄武"];
          } else if (stem === "丙" || stem === "丁") {
            return ["朱雀", "勾陳", "騰蛇", "白虎", "玄武", "青龍"];
          } else if (stem === "戊") {
            return ["勾陳", "騰蛇", "白虎", "玄武", "青龍", "朱雀"];
          } else if (stem === "己") {
            return ["騰蛇", "白虎", "玄武", "青龍", "朱雀", "勾陳"];
          } else if (stem === "庚" || stem === "辛") {
            return ["白虎", "玄武", "青龍", "朱雀", "勾陳", "騰蛇"];
          } else if (stem === "壬" || stem === "癸") {
            return ["玄武", "青龍", "朱雀", "勾陳", "騰蛇", "白虎"];
          } else {
            return ["", "", "", "", "", ""];
          }
        }
      },
      methods: {
        toggleLine(index) {
          this.lines[index].isYang = !this.lines[index].isYang;
        },
        toggleMoving(index) {
          this.lines[index].isMoving = !this.lines[index].isMoving;
        },
        getOpposite(branch) {
          const opposites = {
            "子": "午", "午": "子",
            "丑": "未", "未": "丑",
            "寅": "申", "申": "寅",
            "卯": "酉", "酉": "卯",
            "辰": "戌", "戌": "辰",
            "巳": "亥", "亥": "巳"
          };
          return opposites[branch] || "";
        },
        // 五行生判定：例如「金」生「水」
        produces(x, y) {
          const produceMap = {
            "金": "水",
            "水": "木",
            "木": "火",
            "火": "土",
            "土": "金"
          };
          return produceMap[x] === y;
        },
        // 五行剋判定：例如「金」剋「木」
        overcomes(x, y) {
          const overcomeMap = {
            "金": "木",
            "木": "土",
            "土": "水",
            "水": "火",
            "火": "金"
          };
          return overcomeMap[x] === y;
        },
        // 判定描述：先比對日、月地支與爻的地支（以六親描述首字），然後再依五行判定
        getChongJian(index) {
          let liu = this.currentHexagram.liuQin[index] || "";
          if (!liu) return "";
          // 取六親描述第一個字作為該爻的地支
          let lineBranch = liu.charAt(0);
          let results = [];
          let dayBranch = this.today.dayDi;
          let monthBranch = this.today.monthDi;
          if (dayBranch) {
            if (this.getOpposite(dayBranch) === lineBranch) {
              results.push("日沖");
            } else if (dayBranch === lineBranch) {
              results.push("日建");
            }
          }
          if (monthBranch) {
            if (this.getOpposite(monthBranch) === lineBranch) {
              results.push("月沖");
            } else if (monthBranch === lineBranch) {
              results.push("月建");
            }
          }
          // 五行判定
          let dayElem = this.branchToElement[dayBranch] || "";
          let monthElem = this.branchToElement[monthBranch] || "";
          let lineElem = this.branchToElement[lineBranch] || "";
          if (dayBranch) {
            if (dayElem === lineElem) {
              results.push("日旺");
            } else if (this.produces(dayElem, lineElem)) {
              results.push("日相");
            } else if (this.produces(lineElem, dayElem)) {
              results.push("日休");
            } else if (this.overcomes(dayElem, lineElem)) {
              results.push("日囚");
            }
          }
          if (monthBranch) {
            if (monthElem === lineElem) {
              results.push("月旺");
            } else if (this.produces(monthElem, lineElem)) {
              results.push("月相");
            } else if (this.produces(lineElem, monthElem)) {
              results.push("月休");
            } else if (this.overcomes(monthElem, lineElem)) {
              results.push("月囚");
            }
          }
          return results.join("/");
        },
        getGanzhi(index) {
          return this.heavenlyStems[index % 10] + this.earthlyBranches[index % 12];
        },
        getYearGanzhi(date) {
          let index = (date.getFullYear() - 4) % 60;
          return this.getGanzhi(index);
        },
        getMonthGanzhi(date) {
          let liChun;
          if (date >= new Date(date.getFullYear(), 1, 4)) {
            liChun = new Date(date.getFullYear(), 1, 4);
          } else {
            liChun = new Date(date.getFullYear() - 1, 1, 4);
          }
          let deltaDays = Math.floor((date - liChun) / (1000 * 3600 * 24));
          let m = Math.floor(deltaDays / 30) + 1;
          m = ((m - 1) % 12) + 1;
          let yearStemIndex = (date.getFullYear() - 4) % 10;
          let monthStemIndex = (yearStemIndex * 2 + m + 1) % 10;
          let monthBranches = ['寅','卯','辰','巳','午','未','申','酉','戌','亥','子','丑'];
          return this.heavenlyStems[monthStemIndex] + monthBranches[m - 1];
        },
        getDayGanzhi(date) {
          let ref = new Date(1984, 0, 31);
          let deltaDays = Math.floor((date - ref) / (1000 * 3600 * 24));
          let index = deltaDays % 60;
          return this.getGanzhi(index);
        }
      },
      mounted() {
        let todayDate = new Date();
        let yearGZ = this.getYearGanzhi(todayDate);
        let monthGZ = this.getMonthGanzhi(todayDate);
        let dayGZ = this.getDayGanzhi(todayDate);
        this.today.yearTian = yearGZ.charAt(0);
        this.today.yearDi = yearGZ.charAt(1);
        this.today.monthTian = monthGZ.charAt(0);
        this.today.monthDi = monthGZ.charAt(1);
        this.today.dayTian = dayGZ.charAt(0);
        this.today.dayDi = dayGZ.charAt(1);
      }
    });
  </script>
</body>
</html>
